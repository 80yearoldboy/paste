<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‚®ç®±éªŒè¯ - åœ¨çº¿å‰ªè´´æ¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 500px;
            text-align: center;
        }
        
        .card {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }
        
        .logo {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        p {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: 500;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .loading {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: background 0.3s;
            margin: 5px;
        }
        
        .btn:hover {
            background: #5a6fd8;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .hidden {
            display: none;
        }
        
        .user-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: left;
        }
        
        .user-info h3 {
            margin-bottom: 10px;
            color: #495057;
        }
        
        .user-detail {
            margin-bottom: 5px;
            display: flex;
        }
        
        .user-detail label {
            font-weight: 600;
            min-width: 100px;
        }
        
        .countdown {
            font-size: 14px;
            color: #6c757d;
            margin-top: 10px;
        }
        
        .token-preview {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
            margin: 10px 0;
            text-align: left;
            max-height: 100px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="logo">ğŸ“‹</div>
            <h1>é‚®ç®±éªŒè¯æˆåŠŸ</h1>
            <p>æˆ‘ä»¬æ­£åœ¨ä¸ºæ‚¨å®Œæˆæ³¨å†Œæµç¨‹...</p>
            
            <div class="loading" id="loading"></div>
            
            <div id="success-content" class="hidden">
                <div class="status success">
                    <h2>ğŸ‰ æ­å–œï¼</h2>
                    <p>æ‚¨çš„é‚®ç®±å·²éªŒè¯æˆåŠŸï¼Œè´¦æˆ·å·²æ¿€æ´»ã€‚</p>
                </div>
                
                <div class="user-info">
                    <h3>è´¦æˆ·ä¿¡æ¯</h3>
                    <div class="user-detail">
                        <label>é‚®ç®±:</label>
                        <span id="user-email">447376177@qq.com</span>
                    </div>
                    <div class="user-detail">
                        <label>ç”¨æˆ·å:</label>
                        <span id="user-name">80yearoldboy</span>
                    </div>
                    <div class="user-detail">
                        <label>çŠ¶æ€:</label>
                        <span id="user-status">å·²éªŒè¯</span>
                    </div>
                </div>
                
                <div class="status info">
                    <h3>ä¸‹ä¸€æ­¥</h3>
                    <p>æ‚¨ç°åœ¨å¯ä»¥ç™»å½•å¹¶ä½¿ç”¨åœ¨çº¿å‰ªè´´æ¿çš„æ‰€æœ‰åŠŸèƒ½ã€‚</p>
                </div>
                
                <div>
                    <a href="dashboard.html" class="btn" id="dashboard-btn">è¿›å…¥å‰ªè´´æ¿</a>
                    <a href="index.html" class="btn btn-secondary">è¿”å›é¦–é¡µ</a>
                </div>
                
                <p class="countdown" id="countdown">5ç§’åè‡ªåŠ¨è·³è½¬åˆ°å‰ªè´´æ¿...</p>
            </div>
            
            <div id="error-message" class="hidden">
                <div class="status error">
                    <h2>âŒ å¤„ç†å¤±è´¥</h2>
                    <p id="error-details">å¤„ç†éªŒè¯ä¿¡æ¯æ—¶å‡ºç°é—®é¢˜ã€‚</p>
                </div>
                <a href="register.html" class="btn">é‡æ–°æ³¨å†Œ</a>
                <a href="login.html" class="btn btn-secondary">å°è¯•ç™»å½•</a>
            </div>
            
            <div style="margin-top: 30px; text-align: left;">
                <details>
                    <summary style="cursor: pointer; font-weight: 600;">è°ƒè¯•ä¿¡æ¯</summary>
                    <div style="margin-top: 10px;">
                        <p>æ¥æ”¶åˆ°çš„ä»¤ç‰Œä¿¡æ¯ï¼š</p>
                        <div class="token-preview" id="token-preview"></div>
                        <button class="btn btn-secondary" id="copy-token" style="font-size: 12px; padding: 5px 10px;">å¤åˆ¶ä»¤ç‰Œ</button>
                    </div>
                </details>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2.38.0/dist/umd/supabase.min.js"></script>
    <script>
        // åˆå§‹åŒ– Supabase
        const supabaseUrl = localStorage.getItem('supabase_url') || 'https://your-project.supabase.co';
        const supabaseKey = localStorage.getItem('supabase_key') || 'your-anon-key';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);
        
        // è·å–URLå‚æ•°
        function getUrlParameters() {
            const params = {};
            const queryString = window.location.hash.substring(1) || window.location.search.substring(1);
            const regex = /([^&=]+)=([^&]*)/g;
            let m;
            
            while (m = regex.exec(queryString)) {
                params[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
            }
            
            return params;
        }
        
        // å¤„ç†æˆåŠŸå›è°ƒ
        async function handleSuccessCallback() {
            const loadingEl = document.getElementById('loading');
            const successEl = document.getElementById('success-content');
            const errorEl = document.getElementById('error-message');
            const errorDetailsEl = document.getElementById('error-details');
            const tokenPreviewEl = document.getElementById('token-preview');
            
            try {
                // è·å–URLå‚æ•°
                const params = getUrlParameters();
                
                // æ˜¾ç¤ºä»¤ç‰Œé¢„è§ˆï¼ˆå‰50ä¸ªå­—ç¬¦ï¼‰
                if (params.access_token) {
                    tokenPreviewEl.textContent = params.access_token.substring(0, 50) + '...';
                }
                
                // æ£€æŸ¥å¿…è¦çš„å‚æ•°
                if (!params.access_token) {
                    throw new Error('å›è°ƒURLä¸­ç¼ºå°‘è®¿é—®ä»¤ç‰Œ');
                }
                
                // ä½¿ç”¨Supabaseè®¾ç½®ä¼šè¯
                const { data, error } = await supabase.auth.setSession({
                    access_token: params.access_token,
                    refresh_token: params.refresh_token
                });
                
                if (error) {
                    throw error;
                }
                
                if (data && data.user) {
                    // éªŒè¯æˆåŠŸï¼Œæ›´æ–°ç”¨æˆ·ä¿¡æ¯
                    document.getElementById('user-email').textContent = data.user.email;
                    if (data.user.user_metadata && data.user.user_metadata.username) {
                        document.getElementById('user-name').textContent = data.user.user_metadata.username;
                    }
                    
                    // æ˜¾ç¤ºæˆåŠŸå†…å®¹
                    loadingEl.style.display = 'none';
                    successEl.classList.remove('hidden');
                    
                    // å¼€å§‹å€’è®¡æ—¶
                    startCountdown();
                } else {
                    throw new Error('æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯');
                }
            } catch (error) {
                console.error('å¤„ç†å›è°ƒé”™è¯¯:', error);
                loadingEl.style.display = 'none';
                errorEl.classList.remove('hidden');
                
                // æä¾›æ›´å‹å¥½çš„é”™è¯¯ä¿¡æ¯
                let errorMessage = 'å¤„ç†éªŒè¯ä¿¡æ¯æ—¶å‡ºç°é—®é¢˜ã€‚';
                if (error.message.includes('Invalid Refresh Token')) {
                    errorMessage = 'åˆ·æ–°ä»¤ç‰Œæ— æ•ˆï¼Œè¯·é‡æ–°ç™»å½•ã€‚';
                } else if (error.message.includes('Auth session missing')) {
                    errorMessage = 'è®¤è¯ä¼šè¯ä¸¢å¤±ï¼Œè¯·é‡æ–°éªŒè¯ã€‚';
                }
                
                errorDetailsEl.textContent = errorMessage;
            }
        }
        
        // å€’è®¡æ—¶å¹¶è‡ªåŠ¨è·³è½¬
        function startCountdown() {
            let countdown = 5;
            const countdownEl = document.getElementById('countdown');
            const dashboardBtn = document.getElementById('dashboard-btn');
            
            const countdownInterval = setInterval(() => {
                countdown--;
                countdownEl.textContent = `${countdown}ç§’åè‡ªåŠ¨è·³è½¬åˆ°å‰ªè´´æ¿...`;
                
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    window.location.href = 'dashboard.html';
                }
            }, 1000);
            
            // ç‚¹å‡»æŒ‰é’®ç«‹å³è·³è½¬
            dashboardBtn.addEventListener('click', () => {
                clearInterval(countdownInterval);
            });
        }
        
        // å¤åˆ¶ä»¤ç‰ŒåŠŸèƒ½
        document.getElementById('copy-token').addEventListener('click', function() {
            const params = getUrlParameters();
            if (params.access_token) {
                navigator.clipboard.writeText(params.access_token).then(() => {
                    alert('ä»¤ç‰Œå·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                });
            }
        });
        
        // é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹å¤„ç†
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥Supabaseæ˜¯å¦é…ç½®æ­£ç¡®
            if (supabaseUrl.includes('your-project') || supabaseKey.includes('your-anon-key')) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error-message').classList.remove('hidden');
                document.getElementById('error-details').textContent = 
                    'Supabase é…ç½®ä¸æ­£ç¡®ã€‚è¯·ç¡®ä¿åœ¨æ³¨å†Œé¡µé¢æ­£ç¡®é…ç½®äº† Supabase URL å’Œ Keyã€‚';
                return;
            }
            
            handleSuccessCallback();
        });
    </script>
</body>
</html>
