<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>邮箱验证 - 在线剪贴板</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 500px;
            text-align: center;
        }
        
        .card {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }
        
        .logo {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        p {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: 500;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .loading {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: background 0.3s;
            margin: 5px;
        }
        
        .btn:hover {
            background: #5a6fd8;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .hidden {
            display: none;
        }
        
        .user-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: left;
        }
        
        .user-info h3 {
            margin-bottom: 10px;
            color: #495057;
        }
        
        .user-detail {
            margin-bottom: 5px;
            display: flex;
        }
        
        .user-detail label {
            font-weight: 600;
            min-width: 100px;
        }
        
        .countdown {
            font-size: 14px;
            color: #6c757d;
            margin-top: 10px;
        }
        
        .token-preview {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
            margin: 10px 0;
            text-align: left;
            max-height: 100px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="logo">📋</div>
            <h1>邮箱验证成功</h1>
            <p>我们正在为您完成注册流程...</p>
            
            <div class="loading" id="loading"></div>
            
            <div id="success-content" class="hidden">
                <div class="status success">
                    <h2>🎉 恭喜！</h2>
                    <p>您的邮箱已验证成功，账户已激活。</p>
                </div>
                
                <div class="user-info">
                    <h3>账户信息</h3>
                    <div class="user-detail">
                        <label>邮箱:</label>
                        <span id="user-email">447376177@qq.com</span>
                    </div>
                    <div class="user-detail">
                        <label>用户名:</label>
                        <span id="user-name">80yearoldboy</span>
                    </div>
                    <div class="user-detail">
                        <label>状态:</label>
                        <span id="user-status">已验证</span>
                    </div>
                </div>
                
                <div class="status info">
                    <h3>下一步</h3>
                    <p>您现在可以登录并使用在线剪贴板的所有功能。</p>
                </div>
                
                <div>
                    <a href="dashboard.html" class="btn" id="dashboard-btn">进入剪贴板</a>
                    <a href="index.html" class="btn btn-secondary">返回首页</a>
                </div>
                
                <p class="countdown" id="countdown">5秒后自动跳转到剪贴板...</p>
            </div>
            
            <div id="error-message" class="hidden">
                <div class="status error">
                    <h2>❌ 处理失败</h2>
                    <p id="error-details">处理验证信息时出现问题。</p>
                </div>
                <a href="register.html" class="btn">重新注册</a>
                <a href="login.html" class="btn btn-secondary">尝试登录</a>
            </div>
            
            <div style="margin-top: 30px; text-align: left;">
                <details>
                    <summary style="cursor: pointer; font-weight: 600;">调试信息</summary>
                    <div style="margin-top: 10px;">
                        <p>接收到的令牌信息：</p>
                        <div class="token-preview" id="token-preview"></div>
                        <button class="btn btn-secondary" id="copy-token" style="font-size: 12px; padding: 5px 10px;">复制令牌</button>
                    </div>
                </details>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2.38.0/dist/umd/supabase.min.js"></script>
    <script>
        // 初始化 Supabase
        const supabaseUrl = localStorage.getItem('supabase_url') || 'https://your-project.supabase.co';
        const supabaseKey = localStorage.getItem('supabase_key') || 'your-anon-key';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);
        
        // 获取URL参数
        function getUrlParameters() {
            const params = {};
            const queryString = window.location.hash.substring(1) || window.location.search.substring(1);
            const regex = /([^&=]+)=([^&]*)/g;
            let m;
            
            while (m = regex.exec(queryString)) {
                params[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
            }
            
            return params;
        }
        
        // 处理成功回调
        async function handleSuccessCallback() {
            const loadingEl = document.getElementById('loading');
            const successEl = document.getElementById('success-content');
            const errorEl = document.getElementById('error-message');
            const errorDetailsEl = document.getElementById('error-details');
            const tokenPreviewEl = document.getElementById('token-preview');
            
            try {
                // 获取URL参数
                const params = getUrlParameters();
                
                // 显示令牌预览（前50个字符）
                if (params.access_token) {
                    tokenPreviewEl.textContent = params.access_token.substring(0, 50) + '...';
                }
                
                // 检查必要的参数
                if (!params.access_token) {
                    throw new Error('回调URL中缺少访问令牌');
                }
                
                // 使用Supabase设置会话
                const { data, error } = await supabase.auth.setSession({
                    access_token: params.access_token,
                    refresh_token: params.refresh_token
                });
                
                if (error) {
                    throw error;
                }
                
                if (data && data.user) {
                    // 验证成功，更新用户信息
                    document.getElementById('user-email').textContent = data.user.email;
                    if (data.user.user_metadata && data.user.user_metadata.username) {
                        document.getElementById('user-name').textContent = data.user.user_metadata.username;
                    }
                    
                    // 显示成功内容
                    loadingEl.style.display = 'none';
                    successEl.classList.remove('hidden');
                    
                    // 开始倒计时
                    startCountdown();
                } else {
                    throw new Error('无法获取用户信息');
                }
            } catch (error) {
                console.error('处理回调错误:', error);
                loadingEl.style.display = 'none';
                errorEl.classList.remove('hidden');
                
                // 提供更友好的错误信息
                let errorMessage = '处理验证信息时出现问题。';
                if (error.message.includes('Invalid Refresh Token')) {
                    errorMessage = '刷新令牌无效，请重新登录。';
                } else if (error.message.includes('Auth session missing')) {
                    errorMessage = '认证会话丢失，请重新验证。';
                }
                
                errorDetailsEl.textContent = errorMessage;
            }
        }
        
        // 倒计时并自动跳转
        function startCountdown() {
            let countdown = 5;
            const countdownEl = document.getElementById('countdown');
            const dashboardBtn = document.getElementById('dashboard-btn');
            
            const countdownInterval = setInterval(() => {
                countdown--;
                countdownEl.textContent = `${countdown}秒后自动跳转到剪贴板...`;
                
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    window.location.href = 'dashboard.html';
                }
            }, 1000);
            
            // 点击按钮立即跳转
            dashboardBtn.addEventListener('click', () => {
                clearInterval(countdownInterval);
            });
        }
        
        // 复制令牌功能
        document.getElementById('copy-token').addEventListener('click', function() {
            const params = getUrlParameters();
            if (params.access_token) {
                navigator.clipboard.writeText(params.access_token).then(() => {
                    alert('令牌已复制到剪贴板');
                }).catch(err => {
                    console.error('复制失败:', err);
                });
            }
        });
        
        // 页面加载完成后开始处理
        document.addEventListener('DOMContentLoaded', function() {
            // 检查Supabase是否配置正确
            if (supabaseUrl.includes('your-project') || supabaseKey.includes('your-anon-key')) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error-message').classList.remove('hidden');
                document.getElementById('error-details').textContent = 
                    'Supabase 配置不正确。请确保在注册页面正确配置了 Supabase URL 和 Key。';
                return;
            }
            
            handleSuccessCallback();
        });
    </script>
</body>
</html>
